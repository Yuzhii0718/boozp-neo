<--! baidu map -->
<script type="text/javascript">
    document.getElementById('night-mode-toggle').addEventListener('click', function () {
        document.body.classList.toggle('night-mode');
    });

    var map = new BMap.Map("map");          // 创建地图实例

    var point = new BMap.Point(116.418261, 39.921984);
    map.centerAndZoom(point, 8);             // 初始化地图，设置中心点坐标和地图级别
    map.enableScrollWheelZoom(); // 允许滚轮缩放

    var msg = document.getElementById("jsoncode").innerText;
    var de = JSON.parse(msg);
    console.log(de);
    var points = de;
    console.log(points);

    if (!isSupportCanvas()) {
        alert('热力图目前只支持有canvas支持的浏览器,您所使用的浏览器不能使用热力图功能~')
    }

    heatmapOverlay = new BMapLib.HeatmapOverlay({"radius": 20, "visible": true, "opacity": 10});
    map.addOverlay(heatmapOverlay);
    heatmapOverlay.setDataSet({data: points, max: 1000});
    heatmapOverlay.show();

    function openHeatmap() {
        heatmapOverlay.show();
    }

    function closeHeatmap() {
        heatmapOverlay.hide();
    }

    closeHeatmap();

    function setGradient() {
        var gradient = {};
        var colors = document.querySelectorAll("input[type='color']");
        colors = [].slice.call(colors, 0);
        colors.forEach(function (ele) {
            gradient[ele.getAttribute("data-key")] = ele.value;
        });
        heatmapOverlay.setOptions({"gradient": gradient});
    }

    function isSupportCanvas() {
        var elem = document.createElement('canvas');
        return !!(elem.getContext && elem.getContext('2d'));
    }
</script>

def get_heatmap():
    """
    获取热力图数据
    :keyword: street 热力图
    :return:
    """
    sql_str = ("SELECT street, COUNT(1) FROM {} GROUP BY street HAVING COUNT(1) > {}"
               .format(db_ctable, min_region_num))
    return get_data(sql_str, 'b')